AWSTemplateFormatVersion: 2010-09-09
Description: "clarkp Test Instance"

Parameters:
  KeyName:
    Description: Name of an existing EC2 key pair for EC2 instance Access.
    Type: AWS::EC2::KeyPair::KeyName

Resources: 
  PostgreSQL-DSM:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-0f2b4fc905b0bd1f1
      InstanceType: t2.large
      KeyName: !Ref KeyName
      PrivateIpAddress: String
      BlockDeviceMappings:
        Ebs:
          DeleteOnTermination: true
          VolumeSize: 100
      SecurityGroupIds:
      - sg-0edbc623dc87e2892
      - sg-0f0b0eb448eeccce1
      Tags:
      - Key: Name
        Value: DSM-Postgresql-96
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm 
          sudo systemctl enable amazon-ssm-agent
          sudo systemctl start amazon-ssm-agent
          yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
          yum install postgresql96 postgresql96-server -y
          /usr/pgsql-9.6/bin/postgresql96-setup initdb
          systemctl enable postgresql-9.6
          systemctl start postgresql-9.6
          sudo sed -i "s/local   all             all                                     peer/local   all             all                                     trust/g" /var/lib/pgsql/9.6/data/pg_hba.conf
          sudo sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/g" /var/lib/pgsql/9.6/data/postgresql.conf
          sed -i "82 a host    dsm        all         172.31.0.0/16       trust" /var/lib/pgsql/9.6/data/pg_hba.conf
          systemctl restart postgresql-9.6
          psql -U postgres <<EOF
          CREATE DATABASE dsm;
          CREATE USER mydsm with encrypted password 'N0virus1!';
          GRANT ALL PRIVILEGES ON DATABASE dsm to mydsm;
          GRANT ALL ON DATABASE dsm to mydsm;
          GRANT CONNECT ON DATABASE dsm to mydsm;
          ALTER ROLE mydsm CREATEDB CREATEROLE;
          EOF
          exit
          systemctl restart postgresql-9.6